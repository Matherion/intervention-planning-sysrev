---
title: "Data Extraction Structure"
author: "Gjalt-Jorn Ygram Peters"
date: "8 February 2017"
output: html_document
---

```{r setup, include=FALSE}
  knitr::opts_chunk$set(echo = FALSE);
```

```{r message=FALSE, warning=FALSE}

########################################################################
### Paths
########################################################################

### Add any relevant paths to this vector. The script will select the
### correct path itself.

basePathVector <- c("B:/Data/research/intervention-planning-sysrev",
                    "/home/usf/public_html/wim/intervention-planning-sysrev");

########################################################################
### Set the variables with the paths
########################################################################

### Check which paths exist and set the first existing path in the list
### as the base path
basePath <- basePathVector[sapply(basePathVector, dir.exists)][1];
if (is.na(basePath)) stop("None of the basePaths exists!");

### Set the additional paths
outputPath <- basePath;

########################################################################
### Load packages
########################################################################

### Packages
require('userfriendlyscience');
safeRequire('googlesheets');
safeRequire('data.tree');
safeRequire('networkD3')
safeRequire('DiagrammeR')
safeRequire('DiagrammeRsvg')

########################################################################
### Load spreadsheet
########################################################################

### Get authorization to read Google sheet
#gs_auth(new_user=TRUE);

### Read google sheet
dat <- gs_read(gs_url(paste0("https://docs.google.com/spreadsheets/d/",
                             "1g__lA6Qd8x9UcUMIZGq_xMcZt584sJ-1sMaLmxm3nUU")));

########################################################################
### Process data
########################################################################

dataFrameNetwork <- as.data.frame(dat[!is.na(dat$Identifier),
                                      unique(c('Identifier', 'Parent', names(dat)))]);
dataFrameNetwork$Parent[is.na(dataFrameNetwork$Parent)] <- 'res';

### Check for non-existent parents
nonExistentParents <- !(dataFrameNetwork$Parent %in% c('res', dataFrameNetwork$Identifier));
if (any(nonExistentParents)) {
  message("Note: the items with the following identifiers have a parent that ",
          "cannot be found in the list of parents: ",
          paste0(paste0("'",
                        dataFrameNetwork$Identifier[nonExistentParents],
                        "' with parent '",
                        dataFrameNetwork$Parent[nonExistentParents],
                        "' on line ", 1+which(dat$Identifier %in% dataFrameNetwork$Identifier[nonExistentParents])),
                 collapse=", "),
          "), so I'm ignoring these.");
}

extractionScriptTree <- FromDataFrameNetwork(dataFrameNetwork);

### https://github.com/gluc/data.tree/issues/88
#SetGraphStyle(extractionScriptTree, rankdir = "LR");
#plot(extractionScriptTree);

### Make 
extractionScriptTree$Do(function(node) SetNodeStyle(node, fontcolor = "green",
                                                    color='green'),
                        filterFun = function(node) return(ifelse(is.null(node$Repeating), FALSE, node$Repeating)));

extractionScriptDiagram <- ToDiagrammeRGraph(extractionScriptTree, direction = "descend");

extractionScriptDiagram <- set_global_graph_attrs(extractionScriptDiagram, "layout", "dot", "graph");
extractionScriptDiagram <- add_global_graph_attrs(extractionScriptDiagram, "rankdir", "LR", "graph")

render_graph(extractionScriptDiagram);

export_graph(extractionScriptDiagram,
             file_name=file.path(basePath,
                     "extraction script tree.svg"));

# export_graph(grViz(ToGraphViz(extractionScriptTree)),
#              file_name=file.path(basePath,
#                      "extraction script tree.png"));

returnPathToRoot <- function(node) {
  if (node$isRoot) return(node$name) else return(list(node$name, returnPathToRoot(node$parent)));
}

extractionScriptStructurePreparation <- 
  paste0(sapply(sapply(Traverse(extractionScriptTree,
                  traversal="level",
                  filterFun=isNotLeaf),
         function(node) return(returnPathToRoot(node))),
         function(x) return(paste0(rev(unlist(x)), collapse="$"))), " <- list();\n", collapse="");

lapply(Traverse(extractionScriptTree,
                traversal="level",
                filterFun=isLeaf),
       function(x) return(x$level));

extractionScript <- sapply(1:nrow(dat), function(i) {
  if (is.na(dat[i, 'Identifier'])) {
    ### If there is an identifier, this is just an organising element,
    ### assuming there also isn't a description
    if (is.na(dat[i, 'Description'])) {
      ### If there is also no description, print the activity, if
      ### that *is* present
      if (!is.na(dat[i, 'Activity'])) {
        return(paste0(repStr("#", 80), "\n",
                      repStr("#", 80), "\n###\n",
                      dat[i, 'Activity'], "\n###\n",
                      repStr("#", 80), "\n",
                      repStr("#", 80), "\n"));
      }
    }
  } else {
    ### If there is an identifier, this is something to extract. If there
    ### is a description, it is an item; otherwise just an element
    ### in the hierarchy
    if (is.na(dat[i, 'Description'])) {
      
      
      
      ToDataFrameTypeCol(extractionScriptTree);
      
      return(paste0("res$", dat[i, 'Identifier'], " <- list()\n\n"));
    } else {
      return(paste0(repStr("#", 80),
                    "\n### Activity\n",
                    paste0(strwrap(dat[i, 'Activity'], width=72,
                                   prefix='###   '), collapse="\n"),
                    "\n###\n### Description\n",
                    paste0(strwrap(dat[i, 'Description'], width=72,
                                   prefix='###   '), collapse="\n"),
                    "res$", dat[i, 'Identifier'], "\n\n"));
    }
  }
});

writeLines(paste0(extractionScript, collapse=""),
           file.path(basePath,
                     "extraction script template foundation.R"));

```
